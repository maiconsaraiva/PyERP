{% extends "base/dashboard.html" %}
{% load humanize %}
{% load bootstrap4 %}

{% bootstrap_css %}
{% bootstrap_javascript jquery='full' %}
{% bootstrap_messages %}

{% load i18n static %}
{% load erp_tags %}
{% block header %}
    <link rel="shortcut icon" href="{% static '.' %}/dist/favicon.png" type="image/x-icon"/>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="{% static '/plugins/fontawesome-free/css/all.min.css' %}">
    <!-- Ionicons -->
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <!-- Toastr -->
    <link rel="stylesheet" href="{{ STATIC_URL }}plugins/toastr/toastr.min.css">
    <!-- overlayScrollbars -->
    <link rel="stylesheet" href="{% static '/dist/css/adminlte.min.css' %}">
    <!-- Google Font: Source Sans Pro -->
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">

    {{ form.media }}
{% endblock header %}
{% block head %}
    <link rel="stylesheet" href="{% static 'css/formset.css' %}">
{% endblock %}
{% block content %}
<div class="row" style="padding:5px;" >
  <div class="card card-outline col-12">
    <form method="post" class="form">
      {% csrf_token %}
      <div class="card-header">
        {% include 'account/header.html' %}
      </div>
      <div class="card-body">
        <div class="form-row">
          {% if object %}
            <div class="form-group row col-sm-6">
              <label class="col-sm-2 col-xl-2 col-form-label" for="id_name">Name</label>
              <div class="col-sm-9">
                <input type="text" value="{{ object.name }}" class="form-control"  style="width: 100%"  maxlength="80" disabled >
                <span class="help-block">
                </span>
              </div>
            </div>
          {% else %}
            <div class="form-group row col-sm-6">
              <label class="col-sm-2 col-xl-2 col-form-label" for="id_name">Name</label>
              <div class="col-sm-9">
                <input type="text" value="Nuevo" class="form-control"  style="width: 100%"  maxlength="80" disabled >
                <span class="help-block">
                </span>
              </div>
            </div>
          {% endif %}
          {% for field in form %}
            {% if field.auto_id != "id_note" %}
              <div class="form-group row col-sm-6">
                <label class="col-sm-2 col-xl-2 col-form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                <div class="col-sm-9">
                  {{ field }}
                  <span class="help-block">
                    {% for error in field.errors %}
                      <ul>
                        <li class="text-red">{{ error }}</li>
                      </ul>
                    {% endfor %}
                  </span>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
          <div class="tabular inline-related last-related">
            {{ formset.management_form }}
            <fieldset>
              <table id="formset_table" class="table table-striped">
                <thead>
                  <tr>
                    <th class="original"></th>
                    {% for field in formset.form %}
                      {% if not field.widget.is_hidden %}
                        <th class="column-{{ field.name }}">{{ field.label|capfirst }}</th>
                      {% endif %}
                    {% endfor %}
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {% for inline_form in formset %}
                    <tr class="{% cycle 'row1' 'row2' %}" id="{{ formset.prefix }}-{{ forloop.counter0 }}">
                      <td class="original{%if field.errors %} table-danger{% endif %}">
                        {% for hidden in inline_form.hidden_fields %}
                          {{ hidden }}
                        {% endfor %}
                      </td>
                      {% for field in inline_form.visible_fields %}
                        <td class="{% if field.name %}field-{{ field.name }}{% endif %}{%if field.errors %} table-danger{% endif %}">
                            {{ field }}
                        </td>
                      {% endfor %}
                      <td class="field-DELETE"><span id="delete-row" class="delete-row"><li class="fa fa-trash" style="padding-right: 3px;"></li></span></td>
                    </tr>
                  {% endfor %}
                  <tr class="formset-template" id="{{ formset.prefix }}-__prefix__" style="display: none">
                    <td class="original {%if field.errors %}table-danger{% endif %}">
                      {% for hidden in formset.empty_form.hidden_fields %}
                        {{ hidden }}
                      {% endfor %}
                    </td>
                    {% for field in formset.empty_form.visible_fields %}
                      <td class="{% if field.name %}field-{{ field.name }}{% endif %} {%if field.errors %}table-danger{% endif %}">
                          {{ field }}
                      </td>
                    {% endfor %}
                    <td class="field-DELETE"><span id="delete-row" class="delete-row"><li class="fa fa-trash" style="padding-right: 3px;"></li></span></td>
                  </tr>
                </tbody>
                <tfoot>
                </tfoot>
              </table>
            </fieldset>
            <span id="add-row" class="add-row">Add form</span>
          </div>
      </div>
      <!-- /.card-body -->
      <div class="card-footer">
      </div>
      <!-- /.card-footer -->
    </div>
    <!-- /.card -->
  </form>
</div>
{% endblock content %}
{% block scripts %}
<script type="text/javascript">
  $('#add-row').click(function() {
    var form_idx = $('#id_{{ formset.prefix }}-TOTAL_FORMS').val();
    form_cloned = $('<div>').append($('.formset-template').clone()).html().replace(/formset-template/g, '');
    form_cloned = form_cloned.replace(/__prefix__/g, form_idx);
    //alert(form_cloned);
    $('#formset_table tbody').append(form_cloned);
    $('#{{ formset.prefix }}-' + form_idx).show();
    $('#id_{{ formset.prefix }}-TOTAL_FORMS').val(parseInt(form_idx) + 1);

    $("#formset_table tbody tr:visible").each(function (index) {
      $(this).css("background-color", !!(index & 1)? "inherit" : "rgba(0,0,0,.05");
    });

    var datepickerDict = {};
    var isBootstrap4 = $.fn.collapse.Constructor.VERSION.split('.').shift() == "4";
    $("[dp_config]:not([disabled])").each(function (i, element) {
        var $element = $(element), data = {};
        try {
            data = JSON.parse($element.attr('dp_config'));
        }
        catch (x) { }
        if (data.id && data.options) {
            data.$element = $element.datetimepicker(data.options);
            data.datepickerdata = $element.data("DateTimePicker");
            datepickerDict[data.id] = data;
            data.$element.next('.input-group-addon').on('click', function(){
                data.datepickerdata.show();
            });
            if(isBootstrap4){
                data.$element.on("dp.show", function (e) {
                    $('.collapse.in').addClass('show');
                });
            }
        }
    });
    if(isBootstrap4) {
        $('body').on('show.bs.collapse','.bootstrap-datetimepicker-widget .collapse',function(e){
            $(e.target).addClass('in');
        });
        $('body').on('hidden.bs.collapse','.bootstrap-datetimepicker-widget .collapse',function(e){
            $(e.target).removeClass('in');
        });
    }
  });


  $('.delete-row').click(function() {
    id = '#id_' + $(this).closest("tr").attr('id') + '-DELETE';
    $(id).prop('checked', true);
    $(this).closest("tr").hide();
    alert($(id).is(':checked'));

    $("#formset_table tbody tr:visible").each(function (index) {
      $(this).css("background-color", !!(index & 1)? "inherit" : "rgba(0,0,0,.05");
    });
    //$('#id_{{ formset.prefix }}-TOTAL_FORMS').val(parseInt(form_idx) - 1);
  });

  /* =================== Recalculo del asiento contable =================== */
  /*function RecalculateFormset() {
    var formCount = $('#id_{{ formset.prefix }}-TOTAL_FORMS').val();
    var t_credit = 0
    var t_debit = 0

    for (i = 0; i < formCount; i++) {
      if($("#id_{{ formset.prefix }}-" + i + "-id").length){
        var formset_row = document.getElementById('id_{{ formset.prefix }}-' + i + '-id').closest('tr');
        if(formset_row.style.display != "none" && !$("#id_{{ formset.prefix }}-" + i + "-DELETE").is(':checked')){
          t_debit += parseFloat($("#id_{{ formset.prefix }}-" + i + "-debit").val());
          t_credit += parseFloat($("#id_{{ formset.prefix }}-" + i + "-credit").val());
        }
      }
    }
    if (t_credit.toFixed(2) != t_debit.toFixed(2)){
      $("#tr_resumen").addClass("bg-danger");
      toastr.error("{{ _('Unbalanced accounting entry') }}")
    }
    else{
      $("#tr_resumen").removeClass("bg-danger");
    }
    $("#t_credit").html("$ " + t_credit.toFixed(2));
    $("#t_debit").html("$ " + t_debit.toFixed(2));
  }*/


  /* =================== Recalculo del asiento contable =================== */
  /* Si cualquier campo de cualquier linea cambia, se recalcula el asiento  */
  /* contable.                                                               */
  /*$("[id^='id_{{ formset.prefix }}-']").on("change", function (e) {
    RecalculateFormset();
  });*/


  /* =================== Recalculo del asiento contable =================== */
  /* Si marco alguna línea (nota contable) para eliminar del asiento        */
  /* contable, entonces se recalcula el asiento contable.                   */

  /*$("[id^='id_{{ formset.prefix }}-'][id$='-DELETE']").change(function() {
      if(this.checked) {
          RecalculateFormset();
      }
  });*/


  /* =================== Recalculo del asiento contable =================== */
  /* Se agrega las filas del resumen del asiento contable al terminar de    */
  /* cargar la página y se recalcula el asiento contable.                   */

  $(document).ready(function(){
    //$('#formset_table tfoot').append('<tr style="background-color: transparent;"><td colspan="8">&nbsp;</td></tr>');
    $('#formset_table tfoot').append('<tr id="tr_resumen" style="background-color: #563D7C; color: #ffffff;"><td colspan="4"></td><td style="color: #ffffff;" id="t_debit">$ {{ object.debit }}</td><td style="color: #ffffff;" id="t_credit">$ {{ object.credit }}</td><td colspan="2"></td></tr>');
  });
</script>
{% endblock %}
